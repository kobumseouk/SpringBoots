<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주문 배송 상세</title>
  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/common/sidebar.css"> <!-- 사이드바 CSS 링크 추가 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script> <!-- Daum 주소찾기 API 추가 -->
</head>
<body>

<!-- Include header -->
<div id="header-placeholder"></div>

<!-- Main container -->
<div class="container mt-5">
  <div class="columns">
    <!-- Include sidebar -->
    <div id="sidebar-placeholder" class="column is-one-quarter"></div>

    <!-- Order Summary Root Element -->
    <div id="order-summary-root" class="column"></div>
  </div>
</div>

<!-- 배송지 변경 모달 -->
<div id="edit-shipping-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">배송지 변경</p>
      <button class="delete" aria-label="close" onclick="closeShippingModal()"></button>
    </header>
    <section class="modal-card-body">
      <form id="edit-shipping-form">
        <div class="field">
          <label class="label">받는 분</label>
          <div class="control">
            <input class="input" type="text" id="edit-recipient-name" required>
          </div>
        </div>

        <div class="field">
          <label class="label">주소</label>
          <div class="control">
            <input class="input" type="text" id="edit-shipping-address" required>
            <button type="button" class="button is-small is-info mt-2" onclick="openDaumPostcode()">주소찾기</button>
          </div>
        </div>

        <div class="field">
          <label class="label">전화번호</label>
          <div class="control">
            <input class="input" type="tel" id="edit-recipient-contact" required>
          </div>
        </div>
      </form>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="submitShippingUpdate()">수정</button>
      <button class="button" onclick="closeShippingModal()">취소</button>
    </footer>
  </div>
</div>

<script src="/common/sidebar.js"></script> <!-- 사이드바 JS 링크 추가 -->

<script>
  let currentOrder = null; // 현재 주문 정보를 저장할 전역 변수

  function getOrderIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
  }

  document.addEventListener("DOMContentLoaded", function() {
    // Load header.html into #header-placeholder
    fetch("/common/header.html")
            .then(response => {
              if (!response.ok) {
                throw new Error("헤더를 불러오는 중 오류가 발생했습니다.");
              }
              return response.text();
            })
            .then(data => {
              document.getElementById("header-placeholder").innerHTML = data;

              // Load sidebar.html after header is loaded
              return fetch("/common/sidebar.html");
            })
            .then(response => {
              if (!response.ok) {
                throw new Error("사이드바를 불러오는 중 오류가 발생했습니다.");
              }
              return response.text();
            })
            .then(data => {
              document.getElementById("sidebar-placeholder").innerHTML = data;

              // Extract order ID from the URL and load order summary
              const orderId = getOrderIdFromUrl();
              if (orderId) {
                loadOrderSummary(orderId);
              }
            })
            .catch(error => {
              console.error("헤더 또는 사이드바를 로드할 수 없습니다:", error);
            });
  });

  function loadOrderSummary(orderId) {
    fetch(`/api/orders/${orderId}`)
            .then((response) => {
              if (!response.ok) {
                return response.json().then((error) => {
                  throw new Error(error.errorMessage || '주문 정보를 가져오는 중 오류가 발생했습니다.');
                });
              }
              return response.json();
            })
            .then((order) => {
              currentOrder = order; // 현재 주문 정보를 전역 변수에 저장
              renderOrderSummary(order);
            })
            .catch((error) => {
              document.getElementById('order-summary-root').innerHTML = `<div class="notification is-danger">${error.message}</div>`;
            });
  }

  function renderOrderSummary(order) {
    const orderSummaryRoot = document.getElementById('order-summary-root');

    if (!order) {
      orderSummaryRoot.innerHTML = "주문 정보를 불러오는 중입니다...";
      return;
    }

    let itemsHtml = '';
    order.items.forEach((item) => {
      itemsHtml += `
        <div class="box mb-4">
          <div class="media">
            <figure class="media-left">
              <p class="image is-128x128">
                <img src="${item.itemImage}" alt="${item.itemName}">
              </p>
            </figure>
            <div class="media-content">
              <div class="content">
                <p><strong>제품명: </strong>${item.itemName}</p>
                <p><strong>사이즈(mm): </strong>${item.itemsSize}</p>
                <p><strong>수량: </strong>${item.orderitemsQuantity}개</p>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    orderSummaryRoot.innerHTML = `
      <div class="box">
        <h2 class="title is-4 has-text-centered">주문 배송 상세</h2>
        <div class="content">
          <h5 class="title is-5">주문상품 정보</h5>
          ${itemsHtml}

          <hr />

          <h5 class="title is-5">주문자</h5>
          <p class="mb-1">${order.recipientName}</p>
          <p class="mb-1">${order.recipientContact}</p>

          <hr />

          <h5 class="title is-5">주문 상태</h5>
          <p><strong>주문 상태: </strong>${order.orderStatus}</p>

          <hr />

          <h5 class="title is-5">배송지</h5>
          <p class="mb-1">${order.recipientName}</p>
          <p class="mb-1">${order.shippingAddress}</p>
          <p>${order.recipientContact}</p>

          ${
            order.orderStatus !== "Shipped"
                    ? `<div class="mt-3">
                  <button class="button is-link is-light" onclick="editShippingAddress()">배송지 수정</button>
                </div>`
                    : ""
    }

          <hr />

          <h5 class="title is-5">결제 금액</h5>
          <p class="mb-1"><strong>총 상품 금액: </strong>₩${order.ordersTotalPrice}</p>
          <p class="mb-1"><strong>배송비: </strong>₩${order.deliveryFee}</p>
          <p><strong>총 결제 금액: </strong>₩${order.ordersTotalPrice + order.deliveryFee}</p>

          <div class="mt-4 has-text-centered">
          </div>
        </div>
      </div>
    `;
  }

  function editShippingAddress() {
    // 모달 열기
    document.getElementById("edit-shipping-modal").classList.add("is-active");

    // 현재 배송 정보를 모달 폼에 채우기
    document.getElementById("edit-recipient-name").value = currentOrder.recipientName;
    document.getElementById("edit-shipping-address").value = currentOrder.shippingAddress;
    document.getElementById("edit-recipient-contact").value = currentOrder.recipientContact;
  }

  function closeShippingModal() {
    document.getElementById("edit-shipping-modal").classList.remove("is-active");
  }

  function submitShippingUpdate() {
    let updateOrderRequest = {
      recipient_name: document.getElementById("edit-recipient-name").value,
      shipping_address: document.getElementById("edit-shipping-address").value,
      recipient_contact: document.getElementById("edit-recipient-contact").value,
    };

    // 유효성 검사 추가
    if (!updateOrderRequest.recipient_name || !updateOrderRequest.shipping_address || !updateOrderRequest.recipient_contact) {
      alert('모든 필수 정보를 입력해주세요: 받는 분, 주소, 전화번호');
      return;
    }

    // PUT 요청으로 배송 정보 업데이트
    fetch(`/api/orders/${currentOrder.ordersId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(updateOrderRequest)
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then((error) => {
                  throw new Error(error.errorMessage || '배송 정보를 업데이트하는 중 오류가 발생했습니다.');
                });
              }
              return response.json();
            })
            .then(() => {
              closeShippingModal();
              loadOrderSummary(currentOrder.ordersId); // 업데이트된 주문 정보 다시 로드
            })
            .catch(error => {
              alert(error.message);
            });
  }


  function openDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        // 검색 결과에서 선택된 주소를 가져와서 입력
        document.getElementById("edit-shipping-address").value = data.address;
      }
    }).open();
  }
</script>
</body>
</html>
